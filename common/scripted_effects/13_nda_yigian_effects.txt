
nda_effect_yigian_setup = {
		# Set Country Leader as Cultist if not already
		every_scope_character = {
			limit = { 
				is_ruler = yes 
				has_yigian_trait = no 
			}
			add_trait = nda_yig_master # need to add to heirs as well?
			change_character_religion = rel:nda_rel_yigian
			nda_effect_ensure_cult_ideology = yes
		}

		# set state religion
		set_state_religion = rel:nda_rel_yigian
		# make recognized if not already
		set_country_type = recognized
		
		# set cult to be cultists and to be power brokers
		ig:ig_nda_cult_worshippers = {
			set_interest_group_name = ig_nda_yigian_church

			IF = {
				limit = { NOT = { has_modifier = nda_ig_secret_masters_modifier } }
				add_modifier = {
					name = nda_ig_secret_masters_modifier
				}
			}
		}

		# remove anti-slavery from intel and trade unions 
		every_interest_group = {
			limit = { has_ideology = ideology_anti_slavery }
			remove_ideology = ideology_anti_slavery
		}

		# set (not so) secret goals - need to check they exist!
		IF = {
			limit = {
				exists = c:NEN
			}
			set_secret_goal = {
				country = c:NEN
				secret_goal = antagonize
			}			
		}
		IF = {
			limit = {
				exists = c:ELD
			}
			set_secret_goal = {
				country = c:ELD
				secret_goal = befriend
			}			
		}
		IF = {
			limit = {
				exists = c:DGN
			}
			set_secret_goal = {
				country = c:DGN
				secret_goal = befriend
			}			
		}


		set_strategy = ai_strategy_nda_eldritch_administrative_agenda
		set_strategy = ai_strategy_nda_eldritch_diplomatic_agenda
		set_strategy = ai_strategy_nda_eldritch_political_agenda
}

nda_effect_yigian_annex = {
	# annex a single country that openly supports YIG
	debug_log = "Yigian - Annex Check."	

	if = {
		limit = {
			any_country = { 			
				is_player = no		
				NOT = { 
					is_full_cult_country = { COUNTRY="THIS" }				
				}
				has_variable = nda_yig_in_open		
			}
		} 

		ordered_country = {
			limit = {
				is_player = no		
				NOT = { 
					is_full_cult_country = { COUNTRY="THIS" }				
				}
				has_variable = nda_yig_in_open			
			}
			order_by = { subtract = global_country_ranking }
			position = 1

			save_scope_as = nda_yigian_annex			
		}

		debug_log = "Yigian - Country surrenders."	
		debug_log_scopes = yes	

		# send notification - does country still exist after annex?
		every_country = {
				post_notification = nda_yigian_lands_expand
		}

		annex = scope:nda_yigian_annex
	}	
	else = {
		debug_log = "YIG - No Country surrenders."	
	}
}

nda_effect_yigian_influence = { # boost to yigian influence in area 

	# Yigian States
	if = {
		limit = {
			exists = ROOT
			has_variable = nda_yig_in_open 
		}

		debug_log = "Has YIG in open : [THIS.GetCountry.GetNameNoFormatting]" 
		debug_log_scopes = no

		# give them a boost, both religion and pops
		every_scope_state = {
			limit = { exists = THIS }
			convert_population = { target = rel:nda_rel_yigian value = 0.10 }	

			# everyone of Yigian Culture should follow Rite 
			every_scope_pop = {
				limit ={
					culture = cu:nda_cul_yigian
				}
				change_pop_religion = { target = rel:nda_rel_yigian value = 1 }			
			}	
			# everyone of Yig Religion should follow Rite 
			every_scope_pop = {
				limit ={
					has_pop_religion = nda_rel_yigian
					NOT = { culture = cu:nda_cul_yigian }
				}
				change_pop_culture = { target = cu:nda_cul_yigian value = 1 }			
			}				
		}

		# Mass Delusion		
		add_loyalists = { value = 1 religion = rel:nda_rel_yigian } #add_loyalists = { value = x pop_type = <key> strata = <key> culture = <scope/cu:key> religion = <scope/rel:key> }
		add_loyalists = { value = 1 culture = cu:nda_cul_yigian }
		add_loyalists = { value = 1 culture = cu:nda_cul_cultist }
		# reduce radicals ??

		#debug_log = "Improve Relations with YIG " 
		#pledge to YIG if they exist
		if = {
			limit = {
				AND = {
					exists = ROOT
					exists = c:YIG
					#c:YIG = { country_rank > root.country_rank }				
					NOT = {
						is_full_cult_country = { COUNTRY="ROOT" }				
					}					
				}
			}

			# always change relationship
			change_relations = { country = c:YIG value = 50 }
			debug_log = "Improved Relations with YIG " 
		}	
	}

	# non-cultist in area should worry - decrease relationships
	if = {
		limit = {
			exists = ROOT
			exists = c:YIG
			any_scope_state = { 
					is_potentially_yigian = yes
			}
			NOT = { has_variable = nda_yig_in_open }
			NOT = { has_variable = nda_cultists_in_open }
		}

		change_relations = { country = c:YIG value = -50 }
		debug_log = "Decrease Relations with YIG " 
	}
}

nda_effect_yigian_buff = { # boost to yig		
	if = {
		limit = {
			exists = c:YIG
			c:YIG = ROOT
		}
		# YIG only buffs
		debug_log = "Buff YIG " 

		every_state_region = {
			limit = { 
				exists = THIS
				is_homeland=cu:nda_cul_yigian
				any_neighbouring_state = { owner = ROOT }
			
			}
			add_claim = ROOT						
		}

		debug_log = "YIG Homelands" 
		every_scope_state = { # need to set all non-homelands in YIG as homelands
			limit = {
				exists = THIS 
				state_region = {
					NOT = { is_homeland = cu:nda_cul_yigian }
					# include other Cults as well ??
				}	
			}
			state_region = {
				add_homeland = nda_cul_yigian
			}
			
		}
		# lay claims with neighbours?

		# remove radicals from government while everyone is partying
		add_radicals  = { value = -0.5 }

		# reduce infamy
		change_infamy = -10
	}	
}